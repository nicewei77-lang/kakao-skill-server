이 README.md는 다음 모든 요구사항을 포함한 최종 완성본입니다:
	•	전체 기능
	•	전체 구현 과정
	•	전체 시트 구조
	•	날짜 레이블
	•	출석 규칙
	•	배포 및 카카오 연결
	•	문제 해결 히스토리
	•	개발자/운영자 주의사항
	•	README 생성법
⸻

📘 Linkus Attendance Chatbot Skill Server

카카오 챗봇에서 본인인증 + 출석 조회 자동화를 제공하는 Node.js 기반 스킬 서버입니다.
Google Sheets 데이터를 기반으로 멤버/스태프 본인인증 후
**OUT 카운트 + 상세 출석 내역(날짜별)**을 조회할 수 있습니다.

⸻

✨ 주요 기능

🔐 1. 본인인증
	•	이름 + 전화번호 뒤 4자리로 신원 확인
	•	스태프/멤버 자동 구분
	•	Google Sheets 명단 시트에서 정확한 행 조회
	•	카카오 User ID 기반 세션 유지 (인증 1회 → 이후 바로 출석조회 가능)
	•	인증 완료 후 즉시 #링커스_출석조회 버튼 제공
→ 카카오 시나리오의 출석조회 블록을 자동 실행시키기 위한 트리거

⸻

📊 2. 실시간 출석 조회
	•	출석부 시트(C열 이름)에서 사용자 검색
	•	아웃카운트(N열) 또는 8월 포함(P열) 중 P열 우선 사용
	•	출석 데이터: D~M 열(총 10개 일정)
	•	날짜는 “제 n 회차”가 아니라 시트의 날짜 헤더(D3~M3) 그대로 사용
	•	OUT이 발생한 날짜만 상세 표시
	•	다양한 표기(○, △ (…), x (…)) 자동 분석

⸻

🧮 3. 출석 규칙 자동 처리

원본 값 예	의미	OUT
○, O	출석	0
△ (13:12)	지각	0.5
△ (14 : 10 조퇴)	조퇴	0.5
△ (병결)	병결	0.5
△ (경조사)	경조사	0.5
x	결석	1
x (15:04)	결석	1
x (15:30 조퇴)	조퇴 결석 → 결석 처리	1

✔ 공백/괄호/콜론이 제각각라도 모두 정규식으로 통일하여 파싱됨
✔ OUT이 0인 날짜는 상세내역에 포함되지 않음

⸻

🗂 Google Sheets 구조 (가장 중요!)

🔹 1. 명단 시트: 18기(전 인원) 명단

▪ 범위

A4:S200

▪ 열 구조

구분	열	설명
스태프 이름	C열	COL_STAFF_NAME = 2
스태프 전화	I열	COL_STAFF_PHONE = 8
멤버 이름	L열	COL_MEMBER_NAME = 11
멤버 전화	R열	COL_MEMBER_PHONE = 17

▪ 전화번호 입력 형태

모두 지원됨:
	•	010-1234-5678
	•	01012345678
	•	010 1234 5678

→ 숫자만 추출하여 뒤 4자리로 비교

⸻

🔹 2. 출석부 시트: 출석부

▶ 날짜 헤더(D3~M3)

출석 상세내역에서 그대로 사용됨.

예시:

열	날짜
D3	09월 06일
E3	09월 13일
F3	09월 20일
…	…
M3	11월 29일


⸻

▶ 출석부 데이터 (A5~Q200)

열	설명
C열	이름
D~M 열	출결 데이터(지각/조퇴/결석 등)
N열	아웃카운트(출석)
P열	8월 포함 아웃카운트

출석 데이터(D~M)는 다음 형태를 포함함:
	•	○
	•	△ (13:20)
	•	△ (병결)
	•	△ (경조사)
	•	x
	•	x (조퇴)
	•	x (15:04)
	•	빈칸

parseAttendanceCell()이 모든 케이스를 처리함.

⸻

⚠️ Google Sheets 사용 시 필수 주의사항

❗ 1. 시트 이름 변경 금지

특히 아래 시트는 절대 이름 변경하면 안 됨:
	•	18기(전 인원) 명단
	•	출석부

공백/괄호까지 모두 포함되어야 하며
Google API에서 정확한 문자열 매칭이 필요함.

⸻

❗ 2. 열 순서 변경 절대 금지

아래 열들은 코드가 “열 번호로” 접근하므로 변경되면 전부 오류 남:

시트	열	역할
명단	C	스태프 이름
명단	I	스태프 전화
명단	L	멤버 이름
명단	R	멤버 전화
출석부	C	이름
출석부	D~M	출석 데이터
출석부	N	아웃카운트
출석부	P	8월 포함 OUT


⸻

❗ 3. 날짜 헤더(D3~M3) 비어 있으면 상세내역 날짜가 비어버림

날짜는 “정확히 저기 있는 값”을 그대로 출력하므로
반드시 날짜 값을 채워 넣어야 함.

⸻

❗ 4. 명단 시트의 병합된 셀, 비어있는 행은 오류를 유발할 수 있음
	•	병합된 셀은 API로 가져올 때 row 수가 들쑥날쑥함
	•	200행 범위로 조회 중이며 필요한 경우 A4:S500까지 확장 가능

⸻

⚙️ 서버 구조

index.js
├── Express 서버
├── /kakao (본인인증)
├── /attendance (출석 조회)
├── Google Sheets API client
├── parseAttendanceCell()
└── 세션 관리 Map(lastAuthByUserId)


⸻

🌐 API 엔드포인트

▶ POST /kakao
	•	카카오 스킬 서버가 본인인증 요청 시 호출
	•	성공 시 QuickReplies로 #링커스_출석조회 버튼을 반환
→ 이 버튼을 눌러야 출석조회 블록이 실행됨

▶ POST /attendance
	•	본인 인증된 사용자만 조회 허용
	•	OUT 카운트 + 날짜별 상세내역 문자열 반환
	•	카카오 챗봇 응답 포맷 100% 준수

⸻

🔧 환경 변수(.env)

PORT=3000
GOOGLE_SERVICE_ACCOUNT_KEY={서비스 계정 JSON 전체}

주의: Render에서는 문자열 그대로 넣으면 자동으로 반영됨
줄바꿈 문자가 있어도 문제 없음.

⸻

🚀 배포 과정 (Render 기준)
	1.	GitHub 저장소 연결
	2.	Build Command

npm install


	3.	Start Command

node index.js


	4.	Environment Variables에 GOOGLE_SERVICE_ACCOUNT_KEY 입력
	5.	Deploy
	6.	Render가 HTTPS 도메인을 생성 → 카카오 스킬 URL로 사용

⸻

📡 카카오 챗봇 설정

📌 스킬 URL

(예: Render 도메인이 https://kakao-skill.onrender.com라면)
	•	본인인증

https://kakao-skill.onrender.com/kakao


	•	출석조회

https://kakao-skill.onrender.com/attendance



⸻

📌 본인인증 성공 후 반드시 다음 문자열을 반환해야 함:

#링커스_출석조회

이 문자열이 카카오 시나리오의 출석조회 블록 트리거임.

⸻

🐞 문제 해결 히스토리

1️⃣ Range 파싱 오류

Unable to parse range: '18기(전 인원) 명단'!A4:S200

원인 → 시트 이름에 공백/괄호 존재
해결 → 작은따옴표로 감싸서 사용

'18기(전 인원) 명단'!A4:S200


⸻

2️⃣ 본인인증은 성공했는데 출석조회 블록이 안 열림

원인 → QuickReplies messageText 값이 잘못됨
해결 → 반드시 #링커스_출석조회로 설정

⸻

3️⃣ 상세 날짜가 제n회차로 출력됨

원인 → 날짜 헤더(D3~M3) 사용 안 했음
해결 → 날짜 레이블을 그대로 출력하도록 개선

⸻

4️⃣ Render에서 Google 인증 오류 의심

실제 원인은 토큰 문제 아님
→ 시트 이름/범위 오류였음(출석부의 시트 이름은 '시트1')
→ 수정 후 정상 작동
